############################################
#  render.yaml – Déploiement n8n + IMAP    #
############################################
# 1 web service « n8n »  (plan gratuit)
# 1 base PostgreSQL     (plan gratuit)
# Renseigne les valeurs marquées <…> dans l’UI Render
############################################

services:
  - type: web
    name: n8n
    env: docker
    region: frankfurt        # oregon | frankfurt | singapore
    plan: free
    branch: main
    numInstances: 1
    healthCheckPath: /healthz

    envVars:
      # ──────── Base Postgres n8n ────────
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        fromDatabase: { name: n8nDB, property: host }
      - key: DB_POSTGRESDB_DATABASE
        fromDatabase: { name: n8nDB, property: database }
      - key: DB_POSTGRESDB_PORT
        fromDatabase: { name: n8nDB, property: port }
      - key: DB_POSTGRESDB_USER
        fromDatabase: { name: n8nDB, property: user }
      - key: DB_POSTGRESDB_PASSWORD
        fromDatabase: { name: n8nDB, property: password }
      - key: N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS
        value: "true"
      - key: N8N_RUNNERS_ENABLED
        value: "true"

      # ──────── Réglages généraux ────────
      - key: PORT
        value: "5678"
      - key: N8N_LOG_LEVEL
        value: info
      - key: GENERIC_TIMEZONE
        value: Europe/Paris
      - key: TZ
        value: Europe/Paris
      - key: N8N_DEFAULT_LOCALE
        value: fr
      - key: N8N_ENCRYPTION_KEY
        generateValue: true

      # ──────── Sécurisation UI ──────────
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        value: admin
      - key: N8N_BASIC_AUTH_PASSWORD
        value: "<TON_MDP_UI_N8N>"

      # ──────── URL publiques ────────────
      - key: N8N_HOST
        value: n8n.onrender.com          # remplace par ton sous-domaine
      - key: N8N_PROTOCOL
        value: https
      - key: WEBHOOK_URL
        value: https://n8n.onrender.com/ # sans /webhook/

      # ──────── IMAP (Code node) ────────
      - key: IMAP_HOST
        value: imap.exemple.com
      - key: IMAP_PORT
        value: "993"
      - key: IMAP_USER
        value: login@exemple.com
      - key: IMAP_PASS
        value: "<TON_MDP_IMAP>"
      - key: IMAP_TLS
        value: "true"

      # ──────── Conformité / runners ─────
      - key: N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS
        value: "true"
      - key: N8N_RUNNERS_ENABLED
        value: "true"          # active le mode « internal »
      - key: N8N_RUNNERS_MAX_CONCURRENCY
        value: "2"             # adapte si besoin

databases:
  - name: n8nDB
    region: frankfurt
    plan: free
